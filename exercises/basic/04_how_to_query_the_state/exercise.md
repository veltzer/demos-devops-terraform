# Exercise #4: How to Query the State

Terraform's state is the way in which it is able to keep a cache of infrastructure configuration and its mapping to terraform objects.  The state is used to store information that is generated by the actual resulting infrastructure.  An example of this would be EC2 instances, where the essential config is stored in the \*.tf configuration files, but the instance ID has to be generated by AWS.  After AWS generates this ID, Terraform would record this information in the state.

There are many reasons why you would want to query a state for information, either via CLI or using Terraform's interpolation.  We will experiment with 3 ways this can be done.

### Launch Infrastructure

```bash
terraform init
terraform apply
```

(Have you saved yourself from having to worry about inputting your student alias as a variable for applies/plans across exercises?)

### Command Line

Terraform has a CLI command called "show", which allows users to export useful information from the state in a way that can be easily grep'ed or awk'ed.

```bash
terraform show
```

You should see something like this below:

```
# aws_key_pair.my_key_pair:
resource "aws_key_pair" "my_key_pair" {
    fingerprint = "d7:ff:a6:63:18:64:9c:57:a1:ee:ca:a4:ad:c2:81:62"
    id          = "rockholla-di-force"
    key_name    = "rockholla-di-force"
    key_pair_id = "key-0bbb4f978864fa167"
    public_key  = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQD3F6tyPEFEzV0LX3X8BsXdMsQz1x2cEikKDEY0aIj41qgxMCP/iteneqXSIFZBp5vizPvaoIR3Um9xK7PGoW8giupGn+EPuxIA4cDM4vzOqOkiMPhz5XK0whEjkVzTo4+S0puvDZuwIsdiW9mxhJc7tgBNL0cYlWSYVkz4G/fslNfRPW5mYAM49f4fhtxPb5ok4Q2Lg9dPKVHO/Bgeu5woMc7RY0p1ej6D4CKFE6lymSDJpW0YHX/wqE9+cfEauh7xZcG0q9t2ta6F6fmX0agvpFyZo8aFbXeUBr7osSCJNgvavWbM/06niWrOvYX2xwWdhXmXSrbX8ZbabVohBK41 force+di@rockholla.org"
}

# data.terraform_remote_state.other_project:
data "terraform_remote_state" "other_project" {
    backend   = "local"
    config    = {
        path = "other_project/terraform.tfstate"
    }
    outputs   = {
        bucket_name = "blep-20190110063357193700000001"
    }
    workspace = "default"
}


Outputs:

other_project_bucket = "blep-20190110063357193700000001"
```

Maybe even more helpful, Terraform also supports outputting state in a more machine-readable way:

```bash
terraform show -json
```

Terraform stores state as json, so this is mostly just returning a very similar structure and set of values that you might find in your `terraform.tfstate` file as well, assuming you're using local state. We'll talk more about remote states a little later.

### Remote State Data Type

State is not always stored in a file local to the config. In fact, no production terraform should ever use local state, but working with local state first and primarily in this course is the best way to understand state itself.

If you have another project's state accessible, you can use the remote state data type to parse remote state with interpolation like everything else.  Within this directory, there is a folder called `other_project`.  This folder contains a terraform project that has already generated resources, and so it has a populated tfstate file for us to reference.  If you run the following in the current directory, you will get an output from the state file in `other_project`, and separate from the state of this one which is managing the key pair resource.

```bash
terraform output other_project_bucket
```

If you got "blep-20190110063357193700000001" then this worked successfully.  Take some time you look at the usage of the remote_state data resource and how its implemented in this exercise and play around with it a bit.  Are you able to create another project and get outputs from that project?

### Direct JSON Parse

Since the tfstate files are just JSON files, given the appropriate level of motivation, you could parse it directly to get the information you need.  I don't really consider this a feature of terraform, but rather a side-effect of the way state files exist, so we won't be doing this in this exercise.

### Finishing this exercise

Let's run the following to finish:

```bash
terraform destroy
```
